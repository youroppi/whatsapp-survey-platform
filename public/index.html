<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Survey Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">WhatsApp Survey Platform</h1>
                        <p class="text-gray-600">Admin Dashboard - Manage surveys and analyze responses</p>
                    </div>
                    <div id="back-button" class="hidden">
                        <button onclick="showMainDashboard()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            ‚Üê Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Main Dashboard View -->
            <div id="main-dashboard">
                <!-- Status Panels -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">WhatsApp Connection</h2>
                        <div id="whatsapp-status" class="text-center">
                            <div class="text-blue-600">üîÑ Loading WhatsApp status...</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">AI Voice Features</h2>
                        <div id="openai-status" class="text-center">
                            <div class="text-blue-600">üîÑ Checking AI configuration...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Survey Management -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Survey Management</h2>
                        <button 
                            onclick="showCreateSurvey()" 
                            class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center space-x-2 transition-colors"
                        >
                            <span class="text-lg">+</span>
                            <span>Create Survey</span>
                        </button>
                    </div>
                    
                    <div id="surveys-list" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-4">üìä</div>
                            <p>No surveys created yet. Click "Create Survey" to get started!</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Start Guide -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Start Guide</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-2xl mb-2">1Ô∏è‚É£</div>
                            <h3 class="font-semibold text-blue-800 mb-2">Create Survey</h3>
                            <p class="text-sm text-blue-600">Design questions with multiple choice, ratings, or text responses</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-2xl mb-2">2Ô∏è‚É£</div>
                            <h3 class="font-semibold text-green-800 mb-2">Activate Survey</h3>
                            <p class="text-sm text-green-600">Make your survey live for WhatsApp participants</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-2xl mb-2">3Ô∏è‚É£</div>
                            <h3 class="font-semibold text-purple-800 mb-2">Collect Responses</h3>
                            <p class="text-sm text-purple-600">Share your WhatsApp number and start collecting data!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results View -->
            <div id="results-view" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 id="results-title" class="text-2xl font-bold text-gray-800">Survey Results</h2>
                            <p id="results-subtitle" class="text-gray-600">Analytics and response data</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="exportSurveyData()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center space-x-2">
                                <span>üìä</span>
                                <span>Export CSV</span>
                            </button>
                            <button onclick="exportSurveyDataExcel()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                <span>üìà</span>
                                <span>Export Excel</span>
                            </button>
                        </div>
                    </div>

                    <!-- Overview Stats -->
                    <div id="overview-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <!-- Stats will be populated dynamically -->
                    </div>

                    <!-- Question Results -->
                    <div id="question-results" class="space-y-8">
                        <!-- Question analytics will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Survey Modal -->
    <div id="create-survey-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Create New Survey</h2>
                <button onclick="hideCreateSurvey()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <form id="survey-form">
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Survey Title</label>
                        <input 
                            type="text" 
                            id="survey-title" 
                            required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter survey title"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Survey Description</label>
                        <textarea 
                            id="survey-description" 
                            rows="3"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter a welcome message or description for participants (optional)"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">This message will be shown to participants when they start the survey</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Time</label>
                        <input 
                            type="text" 
                            id="survey-time" 
                            value="3-5 minutes"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="e.g., 3-5 minutes"
                        />
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <label class="block text-sm font-medium text-gray-700">Questions</label>
                            <div class="flex space-x-2">
                                <button type="button" onclick="addQuestion('curated')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                    + Agree/Disagree
                                </button>
                                <button type="button" onclick="addQuestion('multiple')" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                                    + Multiple Choice
                                </button>
                                <button type="button" onclick="addQuestion('likert')" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">
                                    + Rating Scale
                                </button>
                            </div>
                        </div>

                        <div id="questions-container" class="space-y-4">
                            <div class="text-center text-gray-500 py-8 border-2 border-dashed border-gray-300 rounded-lg">
                                <p>No questions added yet. Click the buttons above to add questions.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button 
                        type="submit" 
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        Create Survey
                    </button>
                    <button 
                        type="button" 
                        onclick="hideCreateSurvey()" 
                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let surveys = [];
        let questions = [];
        let currentSurveyResults = null;
        const socket = io();

        // Socket.io event listeners
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('whatsapp-ready', (isReady) => {
            updateWhatsAppStatus(isReady);
        });

        socket.on('qr-code', (data) => {
            updateWhatsAppQR(data.qrCode);
        });

        socket.on('survey-stats', (stats) => {
            surveys = stats;
            renderSurveys();
        });

        // Navigation functions
        function showMainDashboard() {
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('back-button').classList.add('hidden');
        }

        function showResultsView(survey) {
            document.getElementById('main-dashboard').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('back-button').classList.remove('hidden');
            
            document.getElementById('results-title').textContent = `Results: ${survey.title}`;
            document.getElementById('results-subtitle').textContent = `${survey.questions.length} questions ‚Ä¢ ${survey.responses || 0} responses`;
            
            loadSurveyResults(survey.id);
        }

        // Load survey results and analytics
        async function loadSurveyResults(surveyId) {
            try {
                const [analyticsResponse, responsesResponse] = await Promise.all([
                    fetch(`/api/surveys/${surveyId}/analytics`),
                    fetch(`/api/surveys/${surveyId}/responses`)
                ]);
                
                const analytics = await analyticsResponse.json();
                const responses = await responsesResponse.json();
                
                currentSurveyResults = { analytics, responses, surveyId };
                renderSurveyResults(analytics);
            } catch (error) {
                console.error('Error loading survey results:', error);
                alert('Error loading survey results. Please try again.');
            }
        }

        // Render survey results
        function renderSurveyResults(analytics) {
            // Render overview stats
            const statsContainer = document.getElementById('overview-stats');
            statsContainer.innerHTML = `
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-900">${analytics.totalResponses}</div>
                    <div class="text-blue-700 text-sm">Total Responses</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-900">${analytics.uniqueParticipants}</div>
                    <div class="text-green-700 text-sm">Unique Participants</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-900">${analytics.completionRate}%</div>
                    <div class="text-purple-700 text-sm">Completion Rate</div>
                    <div class="text-purple-600 text-xs mt-1">${analytics.completedSurveys}/${analytics.uniqueParticipants} completed</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-orange-900">${analytics.averageCompletionTime || '‚Äî'}</div>
                    <div class="text-orange-700 text-sm">Avg. Time (seconds)</div>
                </div>
            `;

            // Render question results
            const resultsContainer = document.getElementById('question-results');
            resultsContainer.innerHTML = '';

            Object.entries(analytics.responsesByQuestion).forEach(([questionId, data], index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white border border-gray-200 rounded-lg p-6';
                
                let chartHTML = '';
                
                if (data.type === 'likert') {
                    // Render rating scale results
                    const chartId = `chart-${questionId}`;
                    chartHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-3">Rating Distribution</h4>
                                <canvas id="${chartId}" width="400" height="200"></canvas>
                                <div class="mt-2 text-center">
                                    <span class="text-lg font-semibold text-blue-600">Average: ${data.average.toFixed(1)}</span>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-700 mb-3">Comments (${data.followUps.length})</h4>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${data.followUps.slice(0, 5).map(comment => `
                                        <div class="bg-gray-50 p-3 rounded">
                                            <div class="text-xs text-gray-500 mb-1">${comment.participantId}</div>
                                            <div class="text-sm">"${comment.text}"</div>
                                        </div>
                                    `).join('')}
                                    ${data.followUps.length === 0 ? '<p class="text-gray-500 text-sm">No comments yet.</p>' : ''}
                                    ${data.followUps.length > 5 ? `<p class="text-gray-500 text-xs mt-2">+${data.followUps.length - 5} more comments</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Render multiple choice / agree-disagree results
                    const chartId = `chart-${questionId}`;
                    chartHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-3">Response Distribution</h4>
                                <canvas id="${chartId}" width="400" height="200"></canvas>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-700 mb-3">Comments (${data.followUps.length})</h4>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${data.followUps.slice(0, 5).map(comment => `
                                        <div class="bg-gray-50 p-3 rounded">
                                            <div class="text-xs text-gray-500 mb-1">${comment.participantId}</div>
                                            <div class="text-sm">"${comment.text}"</div>
                                        </div>
                                    `).join('')}
                                    ${data.followUps.length === 0 ? '<p class="text-gray-500 text-sm">No comments yet.</p>' : ''}
                                    ${data.followUps.length > 5 ? `<p class="text-gray-500 text-xs mt-2">+${data.followUps.length - 5} more comments</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }

                questionDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        Question ${index + 1}: ${data.question}
                    </h3>
                    ${chartHTML}
                `;

                resultsContainer.appendChild(questionDiv);

                // Create charts after DOM update
                setTimeout(() => {
                    createChart(questionId, data);
                }, 100);
            });
        }

        // Create charts using Chart.js
        function createChart(questionId, data) {
            const canvas = document.getElementById(`chart-${questionId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            if (data.type === 'likert') {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.distribution),
                        datasets: [{
                            label: 'Responses',
                            data: Object.values(data.distribution),
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } else {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.responses),
                        datasets: [{
                            data: Object.values(data.responses),
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(249, 115, 22, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // Export functions
        function exportSurveyData() {
            if (!currentSurveyResults) {
                alert('No survey data to export');
                return;
            }

            const csvContent = generateCSV(currentSurveyResults.responses);
            downloadFile(csvContent, `survey_${currentSurveyResults.surveyId}_responses.csv`, 'text/csv');
        }

        function exportSurveyDataExcel() {
            if (!currentSurveyResults) {
                alert('No survey data to export');
                return;
            }

            // For Excel export, we'll use the same CSV format but with .xlsx extension
            // In a real implementation, you might want to use a library like SheetJS
            const csvContent = generateCSV(currentSurveyResults.responses);
            downloadFile(csvContent, `survey_${currentSurveyResults.surveyId}_responses.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        }

        function generateCSV(responses) {
            if (responses.length === 0) {
                return 'No data available';
            }

            // Updated headers to match the enhanced export format
            const headers = ['ParticipantID', 'Survey', 'Question', 'Answer', 'FollowUpComment', 'PhoneNumber', 'ResponseTimestamp', 'CompletionTimestamp', 'CompletionDuration', 'VoiceTranscribed', 'VoiceLanguage'];
            const rows = responses.map(response => [
                `"${response.ParticipantID}"`,
                `"${response.Survey}"`,
                `"${response.Question}"`,
                `"${response.Answer}"`,
                `"${response.FollowUpComment || ''}"`,
                `"${response.PhoneNumber}"`,
                `"${response.ResponseTimestamp}"`,
                `"${response.CompletionTimestamp || 'Not Completed'}"`,
                `"${response.CompletionDuration || 'N/A'}"`,
                `"${response.VoiceTranscribed}"`,
                `"${response.VoiceLanguage || ''}"`
            ]);

            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // WhatsApp status functions
        function updateWhatsAppStatus(isReady) {
            const statusDiv = document.getElementById('whatsapp-status');
            if (isReady) {
                statusDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="text-green-700 font-semibold mb-2">‚úÖ WhatsApp Connected!</div>
                        <div class="text-green-600 text-sm">Bot is ready to receive messages</div>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="text-yellow-700">üîÑ Waiting for WhatsApp connection...</div>
                    </div>
                `;
            }
        }

        function updateWhatsAppQR(qrCode) {
            const statusDiv = document.getElementById('whatsapp-status');
            statusDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="text-blue-700 font-semibold mb-4">üì± Scan QR Code with WhatsApp:</div>
                    <img src="${qrCode}" alt="WhatsApp QR Code" class="max-w-xs mx-auto rounded-lg border">
                </div>
            `;
        }

        // Load initial status
        async function loadStatus() {
            const whatsappStatus = document.getElementById('whatsapp-status');
            const openaiStatus = document.getElementById('openai-status');
            
            try {
                const whatsappResponse = await fetch('/api/whatsapp/status');
                const whatsappData = await whatsappResponse.json();
                
                if (whatsappData.isReady) {
                    updateWhatsAppStatus(true);
                } else if (whatsappData.qrCode) {
                    updateWhatsAppQR(whatsappData.qrCode);
                } else {
                    updateWhatsAppStatus(false);
                }
            } catch (e) {
                whatsappStatus.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-red-700">‚ùå WhatsApp service error</div>
                    </div>
                `;
            }
            
            try {
                const openaiResponse = await fetch('/api/openai/status');
                const openaiData = await openaiResponse.json();
                
                if (openaiData.isConfigured) {
                    openaiStatus.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-green-700 font-semibold mb-2">‚úÖ Voice AI Enabled</div>
                            <div class="text-green-600 text-sm">üé§ Transcription ‚Ä¢ üåç Translation ‚Ä¢ üß† Validation</div>
                        </div>
                    `;
                } else {
                    openaiStatus.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="text-yellow-700 font-semibold mb-2">‚ö†Ô∏è OpenAI Not Configured</div>
                            <div class="text-yellow-600 text-sm">Add OPENAI_API_KEY to enable voice features</div>
                        </div>
                    `;
                }
            } catch (e) {
                openaiStatus.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-red-700">‚ùå AI service error</div>
                    </div>
                `;
            }
        }

        // Survey Management Functions
        function showCreateSurvey() {
            document.getElementById('create-survey-modal').classList.remove('hidden');
            questions = [];
            renderQuestions();
            
            // Set some example text
            document.getElementById('survey-description').placeholder = `Welcome! We're conducting this survey to gather your valuable feedback about our upcoming course.

Your responses will help us improve the content and delivery to better meet your needs.

All responses are confidential and will be used solely for course improvement purposes.`;
        }

        function hideCreateSurvey() {
            document.getElementById('create-survey-modal').classList.add('hidden');
            document.getElementById('survey-form').reset();
            questions = [];
            renderQuestions();
        }

        function addQuestion(type) {
            const question = {
                id: Date.now(),
                type: type,
                question: '',
                options: type === 'multiple' ? ['Option 1', 'Option 2'] : [],
                scale: type === 'likert' ? { min: 1, max: 5, labels: ['Poor', 'Excellent'] } : null
            };
            
            questions.push(question);
            renderQuestions();
        }

        function removeQuestion(questionId) {
            questions = questions.filter(q => q.id !== questionId);
            renderQuestions();
        }

        function updateQuestion(questionId, field, value) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                question[field] = value;
            }
        }

        function addOption(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.type === 'multiple') {
                question.options.push(`Option ${question.options.length + 1}`);
                renderQuestions();
            }
        }

        function removeOption(questionId, optionIndex) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.type === 'multiple' && question.options.length > 1) {
                question.options.splice(optionIndex, 1);
                renderQuestions();
            }
        }

        function updateOption(questionId, optionIndex, value) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.type === 'multiple') {
                question.options[optionIndex] = value;
            }
        }

        function updateScale(questionId, field, value) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.type === 'likert') {
                if (field === 'min' || field === 'max') {
                    question.scale[field] = parseInt(value);
                } else {
                    question.scale[field] = value;
                }
            }
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8 border-2 border-dashed border-gray-300 rounded-lg">
                        <p>No questions added yet. Click the buttons above to add questions.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = questions.map((question, index) => {
                let questionSpecificHTML = '';
                
                if (question.type === 'multiple') {
                    questionSpecificHTML = `
                        <div class="mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium text-gray-700">Options:</label>
                                <button type="button" onclick="addOption(${question.id})" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                                    + Add Option
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${question.options.map((option, optionIndex) => `
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm text-gray-500 w-8">${optionIndex + 1}.</span>
                                        <input 
                                            type="text" 
                                            value="${option}"
                                            onchange="updateOption(${question.id}, ${optionIndex}, this.value)"
                                            class="flex-1 p-2 border border-gray-300 rounded text-sm"
                                            placeholder="Enter option text"
                                        />
                                        ${question.options.length > 1 ? `
                                            <button type="button" onclick="removeOption(${question.id}, ${optionIndex})" class="text-red-500 hover:text-red-700 p-1">
                                                √ó
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (question.type === 'likert') {
                    questionSpecificHTML = `
                        <div class="mt-3 space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Scale Range:</label>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <input 
                                            type="number" 
                                            value="${question.scale.min}"
                                            onchange="updateScale(${question.id}, 'min', this.value)"
                                            min="1" max="10"
                                            class="w-16 p-2 border border-gray-300 rounded text-sm"
                                        />
                                        <span class="text-gray-500">to</span>
                                        <input 
                                            type="number" 
                                            value="${question.scale.max}"
                                            onchange="updateScale(${question.id}, 'max', this.value)"
                                            min="2" max="10"
                                            class="w-16 p-2 border border-gray-300 rounded text-sm"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Scale Type:</label>
                                    <select onchange="updateScaleLabels(${question.id}, this.value)" class="w-full p-2 border border-gray-300 rounded text-sm mt-1">
                                        <option value="poor-excellent">Poor to Excellent</option>
                                        <option value="disagree-agree">Disagree to Agree</option>
                                        <option value="unsatisfied-satisfied">Unsatisfied to Satisfied</option>
                                        <option value="never-always">Never to Always</option>
                                        <option value="custom">Custom Labels</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Low End Label:</label>
                                    <input 
                                        type="text" 
                                        value="${question.scale.labels[0]}"
                                        onchange="updateScale(${question.id}, 'labels', [this.value, document.querySelector('#high-label-${question.id}').value])"
                                        class="w-full p-2 border border-gray-300 rounded text-sm mt-1"
                                        placeholder="e.g., Poor"
                                    />
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">High End Label:</label>
                                    <input 
                                        type="text" 
                                        id="high-label-${question.id}"
                                        value="${question.scale.labels[1]}"
                                        onchange="updateScale(${question.id}, 'labels', [document.querySelector('input[onchange*=\"${question.id}\"]').value, this.value])"
                                        class="w-full p-2 border border-gray-300 rounded text-sm mt-1"
                                        placeholder="e.g., Excellent"
                                    />
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                                Preview: ${question.scale.min} = ${question.scale.labels[0]} | ${question.scale.max} = ${question.scale.labels[1]}
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-800">Question ${index + 1}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500 capitalize px-2 py-1 bg-gray-100 rounded">
                                    ${question.type === 'curated' ? 'Agree/Disagree' : 
                                      question.type === 'multiple' ? 'Multiple Choice' : 
                                      question.type === 'likert' ? 'Rating Scale' : question.type}
                                </span>
                                <button type="button" onclick="removeQuestion(${question.id})" class="text-red-500 hover:text-red-700 p-1">√ó</button>
                            </div>
                        </div>
                        <textarea 
                            placeholder="Enter your question"
                            required
                            value="${question.question}"
                            onchange="updateQuestion(${question.id}, 'question', this.value)"
                            class="w-full p-3 border border-gray-300 rounded resize-none"
                            rows="2"
                        >${question.question}</textarea>
                        ${questionSpecificHTML}
                    </div>
                `;
            }).join('');
        }

        function updateScaleLabels(questionId, type) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.type === 'likert') {
                const labelSets = {
                    'poor-excellent': ['Poor', 'Excellent'],
                    'disagree-agree': ['Disagree', 'Agree'],
                    'unsatisfied-satisfied': ['Unsatisfied', 'Satisfied'],
                    'never-always': ['Never', 'Always'],
                    'custom': question.scale.labels
                };
                question.scale.labels = labelSets[type] || question.scale.labels;
                renderQuestions();
            }
        }

        // Handle form submission
        document.getElementById('survey-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('survey-title').value;
            const description = document.getElementById('survey-description').value;
            const estimatedTime = document.getElementById('survey-time').value;
            
            if (questions.length === 0) {
                alert('Please add at least one question to your survey.');
                return;
            }

            // Validate questions
            for (let question of questions) {
                if (!question.question.trim()) {
                    alert('Please fill in all question text.');
                    return;
                }
                if (question.type === 'multiple' && question.options.some(opt => !opt.trim())) {
                    alert('Please fill in all option text for multiple choice questions.');
                    return;
                }
            }

            try {
                const response = await fetch('/api/surveys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        estimatedTime: estimatedTime,
                        questions: questions.map((q, index) => ({
                            id: index + 1,
                            type: q.type,
                            question: q.question,
                            options: q.type === 'curated' ? ['Agree', 'Undecided', 'Disagree'] : q.options,
                            scale: q.scale
                        }))
                    })
                });

                if (response.ok) {
                    const survey = await response.json();
                    surveys.push(survey);
                    renderSurveys();
                    hideCreateSurvey();
                    alert('Survey created successfully!');
                } else {
                    alert('Error creating survey. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating survey. Please check your connection.');
            }
        });

        // Render surveys list
        function renderSurveys() {
            const container = document.getElementById('surveys-list');
            
            if (surveys.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üìä</div>
                        <p>No surveys created yet. Click "Create Survey" to get started!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = surveys.map(survey => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-semibold text-gray-800">${survey.title}</h3>
                        <div class="flex items-center space-x-2">
                            ${survey.is_active ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">Active</span>' : ''}
                            <span class="text-sm text-gray-500">${survey.questions?.length || 0} questions</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 text-sm text-gray-600 mb-3">
                        <span>üë• ${survey.total_participants || survey.participants || 0} participants</span>
                        <span>‚úÖ ${survey.completed_participants || survey.completions || 0} completed</span>
                        <span>üìä ${survey.total_responses || survey.responses || 0} responses</span>
                        <span>‚è±Ô∏è ~${survey.estimated_time || '3-5 minutes'}</span>
                    </div>

                    <div class="flex space-x-2">
                        <button 
                            onclick="activateSurvey('${survey.id}')"
                            ${survey.is_active ? 'disabled' : ''}
                            class="px-3 py-1 ${survey.is_active ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'} text-white rounded text-sm"
                        >
                            ${survey.is_active ? 'Active' : 'Activate'}
                        </button>
                        <button 
                            onclick="showResultsView(surveys.find(s => s.id === '${survey.id}'))"
                            class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                        >
                            View Results
                        </button>
                        <button 
                            onclick="exportSurveyById('${survey.id}')"
                            class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600"
                        >
                            Export Data
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Activate survey
        async function activateSurvey(surveyId) {
            try {
                const response = await fetch(`/api/surveys/${surveyId}/activate`, {
                    method: 'POST'
                });

                if (response.ok) {
                    surveys.forEach(s => s.is_active = false);
                    const survey = surveys.find(s => s.id === surveyId);
                    if (survey) survey.is_active = true;
                    
                    renderSurveys();
                    alert('Survey activated! Participants can now respond via WhatsApp.');
                } else {
                    alert('Error activating survey. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error activating survey. Please check your connection.');
            }
        }

        // Export survey by ID (from main dashboard)
        async function exportSurveyById(surveyId) {
            try {
                const response = await fetch(`/api/surveys/${surveyId}/export`);
                const data = await response.json();
                
                if (data.length === 0) {
                    alert('No response data to export for this survey.');
                    return;
                }

                const csvContent = [
                    Object.keys(data[0]).join(','),
                    ...data.map(row => Object.values(row).map(val => `"${val}"`).join(','))
                ].join('\n');

                downloadFile(csvContent, `survey_${surveyId}_responses.csv`, 'text/csv');
            } catch (error) {
                console.error('Error:', error);
                alert('Error exporting survey data. Please try again.');
            }
        }

        // Load existing surveys
        async function loadSurveys() {
            try {
                const response = await fetch('/api/surveys');
                const data = await response.json();
                surveys = data;
                renderSurveys();
            } catch (error) {
                console.error('Error loading surveys:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStatus();
            loadSurveys();
            setInterval(loadStatus, 30000);
        });
    </script>
</body>
</html>
